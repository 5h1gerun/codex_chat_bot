# 🤖 Codex Discord Agent Bot

Raspberry Pi 上で動作する **Codex（CLI）を Discord
から対話型エージェントとして利用する Bot** です。\
通常メッセージで会話しながら指示を出し、開発フォルダ（repo）を切り替えて作業できます。

本Botは **安全性を最優先**に設計されています。

------------------------------------------------------------------------

# ✨ 特徴

-   💬 **通常メッセージで対話型操作**（@bot で話しかけるだけ）\
-   📱 **スマホ操作対応**（入力最小・選択UI中心）\
-   📁 **/repo でフォルダ自動一覧 → タップで切替**\
-   🔄 **repo切替時は自動で対話リセット**\
-   ⏱ **enable制（有効化中のみ反応）**\
-   🔐 **操作範囲は workspace 配下に限定**\
-   📤 **ログは出力しない（回答のみ返却）**\
-   📏 **Discord文字制限対策済み**

------------------------------------------------------------------------

# 🧠 コンセプト

-   Discord = **会話UI**\
-   Raspberry Pi = **実行環境**\
-   Codex = **対話型エージェント**

Botは通常は沈黙し、`/codex enable` された時だけ反応します。\
不用意な常時稼働を避け、**必要な時だけ起動する安全設計**です。

------------------------------------------------------------------------

# 🧱 システム構成

    [ Discord ]
       │
       ▼
    [ Discord Bot ]
       │
       ▼
    [ Raspberry Pi ]
       ├ codex (CLI)
       └ workspaces/
            ├ projectA/
            ├ projectB/
            └ projectC/

------------------------------------------------------------------------

# 📂 ディレクトリ構成（例）

    codex-discord-agent/
    ├ bot.py
    ├ codex_runner.py
    ├ .env
    ├ requirements.txt
    ├ README.md
    └ workspaces/
        ├ Web_Discord_Server/
        ├ music_bot/
        └ screenshot_poke/

------------------------------------------------------------------------

# ⚙️ 動作環境

-   Raspberry Pi OS（推奨）\
-   Python 3.10+\
-   py-cord 2.x\
-   Codex CLI

------------------------------------------------------------------------

# 🔧 セットアップ

## 1. 仮想環境

``` bash
python3 -m venv Discbot
source Discbot/bin/activate
```

## 2. ライブラリ

``` bash
pip install -r requirements.txt
```

## 3. `.env` 作成

``` env
DISCORD_TOKEN=xxxxxxxxxxxxxxxxxxxx
GUILD_ID=123456789012345678

WORKSPACE_ROOT=/home/sh1/Discord_bot
ENABLE_DEFAULT_MINUTES=60
ALLOWED_ROLE_ID=123456789012345678
TARGET_CHANNEL_ID=123456789012345678
CODEX_PATH=/usr/local/bin/codex
CODEX_ARGS=--sandbox danger-full-access
CODEX_TIMEOUT=120
CODEX_SKIP_GIT_CHECK=true
MAX_HISTORY_TURNS=6
MAX_OUTPUT_CHARS=1900
CODEX_LANGUAGE=ja
CODEX_DEFAULT_LANGUAGE=python
```

------------------------------------------------------------------------

# ▶ 起動

``` bash
source Discbot/bin/activate
python bot.py
```

（常駐させる場合は systemd 推奨）

------------------------------------------------------------------------

# 💬 使い方

## 🔓 有効化（必須）

``` text
/codex enable
```

指定時間（デフォルト15分）のみBotが反応します。

``` text
/codex disable
```

で即座に無効化されます。

------------------------------------------------------------------------

## 📁 repo切替（対話リセット）

``` text
/repo list
```

-   `WORKSPACE_ROOT` 配下のフォルダを自動一覧表示\
-   タップで切替\
-   切替と同時に**対話履歴はリセット**
-   Discordの制限により**最大25件**まで表示
-   例: `00_core-`, `10_app-` のような接頭辞で並び順を固定すると運用が楽になります

``` text
/repo list prefix:app-
```

-   先頭一致フィルタで候補を絞り込み

``` text
/repo current
```

現在のrepoを表示

------------------------------------------------------------------------

## 💬 対話（通常メッセージ）

``` text
@codexbot このプロジェクトの構成を説明して
```

``` text
@codexbot 認証周りの改善案を出して
```

※ 有効化中 + 許可チャンネル + 許可ロールのみ反応

------------------------------------------------------------------------

# 📱 スマホ運用を想定した設計

-   入力は `@bot 依頼` だけ\
-   repo切替は **Select UI**\
-   長文は **自動要約 + 分割**\
-   ログを出さず **最終回答のみ表示**

------------------------------------------------------------------------

# 🔐 セキュリティ設計

-   操作可能範囲を `WORKSPACE_ROOT` に固定\
-   `/repo` はフォルダ自動検出（パス入力不可）\
-   enable制（時間制限）\
-   ロール制限\
-   チャンネル制限\
-   stdout / stderr / 実行ログはDiscordに出力しない

------------------------------------------------------------------------

# 📏 Discord文字制限対策

-   2000文字以内：通常返信\
-   超過時：
    -   複数メッセージに分割して返信\
    -   （要約は今後の拡張予定）

※ 実行ログの保存・表示は行いません。

------------------------------------------------------------------------

# 🧠 対話モデル

-   チャンネル単位で状態管理\
-   repo切替時に対話履歴を完全リセット\
-   直近Nターンのみを保持（肥大化防止）

------------------------------------------------------------------------

# 🚀 今後の拡張案

-   repoフィルタ / ページング\
-   GitHub自動コミット\
-   差分プレビュー\
-   Webダッシュボード\
-   作業履歴の可視化

------------------------------------------------------------------------

# ⚠ 注意

このBotは Raspberry Pi 上で Codex を実行します。\
必ず以下を守ってください：

-   VPN / ローカル環境で運用\
-   enable制の使用\
-   操作ユーザーの限定

-----------------------------------------------------------------------

# ✅ 追加セットアップ（Discord設定）

-   Discord Developer Portal で **MESSAGE CONTENT INTENT** を有効化\
-   `GUILD_ID` を指定するとスラッシュコマンドの反映が早くなります

------------------------------------------------------------------------

# 👤 Author

shigerun\
Discord Bot / Raspberry Pi / AI Automation
